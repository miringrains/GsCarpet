{% comment %}
  Cart Page Section
  Modern cart page with Alpine.js integration
{% endcomment %}

<section class="cart-page section" x-data="cartPage()">
  <div class="container">
    <!-- Page Header -->
    <header class="cart-page__header">
      <h1 class="cart-page__title">Your Cart</h1>
      <a href="{{ routes.all_products_collection_url }}" class="cart-page__continue">
        ‚Üê Continue Shopping
      </a>
    </header>

    <!-- Empty Cart State -->
    <div class="cart-empty" x-show="items.length === 0" x-cloak x-transition.opacity.scale.origin.top.duration.400ms>
      <div class="cart-empty__content">
        <svg class="cart-empty__icon" width="80" height="80" viewBox="0 0 24 24" fill="none">
          <path d="M3 3H5L5.4 5M7 13H17L21 5H5.4M7 13L5.4 5M7 13L4.707 15.293C4.077 15.923 4.523 17 5.414 17H17M17 13V17M9 19C9 20.105 8.105 21 7 21C5.895 21 5 20.105 5 19C5 17.895 5.895 17 7 17C8.105 17 9 17.895 9 19ZM19 19C19 20.105 18.105 21 17 21C15.895 21 15 20.105 15 19C15 17.895 15.895 17 17 17C18.105 17 19 17.895 19 19Z" stroke="currentColor" stroke-width="1.5"/>
        </svg>
        <h2 class="cart-empty__title">Your cart is empty</h2>
        <p class="cart-empty__text">Looks like you haven't added anything to your cart yet.</p>
        <a href="{{ routes.all_products_collection_url }}" class="btn btn--primary btn--large hover-lift">
          Start Shopping
        </a>
      </div>
    </div>

    <!-- Cart Items -->
    <div class="cart-content" x-show="items.length > 0" x-cloak x-transition.opacity.duration.400ms>
      <div class="cart-items">
        <template x-for="(item, index) in items" :key="item.key">
          <div class="cart-item">
            <!-- Item Image -->
            <div class="cart-item__image">
              <a :href="item.url">
                <img :src="item.image" :alt="item.product_title" loading="lazy">
              </a>
            </div>

            <!-- Item Details -->
            <div class="cart-item__details">
              <h3 class="cart-item__title">
                <a :href="item.url" x-text="item.product_title"></a>
              </h3>
              <p class="cart-item__variant" x-show="item.variant_title" x-text="item.variant_title"></p>
              <p class="cart-item__price" x-text="formatMoney(item.price)"></p>
            </div>

            <!-- Quantity Controls -->
            <div class="cart-item__quantity">
              <button 
                class="cart-item__quantity-btn"
                @click="updateQuantity(index + 1, item.quantity - 1)"
                :disabled="item.quantity <= 1 || loading"
              >
                <svg width="16" height="16" viewBox="0 0 16 16" fill="none">
                  <path d="M4 8H12" stroke="currentColor" stroke-width="1.5"/>
                </svg>
              </button>
              <input 
                type="number" 
                class="cart-item__quantity-input"
                :value="item.quantity"
                @change="updateQuantity(index + 1, parseInt($event.target.value))"
                :disabled="loading"
                min="1"
              >
              <button 
                class="cart-item__quantity-btn"
                @click="updateQuantity(index + 1, item.quantity + 1)"
                :disabled="loading"
              >
                <svg width="16" height="16" viewBox="0 0 16 16" fill="none">
                  <path d="M8 4V12M4 8H12" stroke="currentColor" stroke-width="1.5"/>
                </svg>
              </button>
            </div>

            <!-- Line Total -->
            <div class="cart-item__total">
              <p class="cart-item__total-price" x-text="formatMoney(item.line_price)"></p>
            </div>

            <!-- Remove Button -->
            <button 
              class="cart-item__remove"
              @click="removeItem(index + 1)"
              :disabled="loading"
              aria-label="Remove item"
            >
              <svg width="20" height="20" viewBox="0 0 20 20" fill="none">
                <path d="M15 5L5 15M5 5L15 15" stroke="currentColor" stroke-width="1.5"/>
              </svg>
            </button>
          </div>
        </template>
      </div>

      <!-- Cart Summary -->
      <div class="cart-summary">
        <div class="cart-summary__content">
          <h2 class="cart-summary__title">Order Summary</h2>
          
          <!-- Subtotal -->
          <div class="cart-summary__row">
            <span>Subtotal</span>
            <span x-text="formatMoney(total_price)"></span>
          </div>

          <!-- Note -->
          <div class="cart-summary__note">
            <label for="cart-note">Order notes (optional)</label>
            <textarea 
              id="cart-note" 
              name="note" 
              class="cart-summary__note-input"
              x-model="note"
              @change="updateNote()"
              placeholder="Add a note to your order..."
            ></textarea>
          </div>

          <!-- Shipping Notice -->
          <p class="cart-summary__shipping">
            Shipping & taxes calculated at checkout
          </p>

          <!-- Checkout Button -->
          <button 
            class="btn btn--primary btn--large cart-summary__checkout"
            @click="checkout()"
            :disabled="loading"
          >
            <span x-show="!loading">Proceed to Checkout</span>
            <span x-show="loading">Updating...</span>
          </button>
        </div>
      </div>
    </div>

    <!-- Loading Overlay -->
    <div class="cart-loading" x-show="loading" x-cloak x-transition.opacity.duration.300ms>
      <div class="cart-loading__spinner spring-spinner"></div>
    </div>
  </div>
</section>

<script>
  Alpine.data('cartPage', () => ({
    items: {{ cart.items | json }},
    total_price: {{ cart.total_price | default: 0 }},
    note: {{ cart.note | json }},
    loading: false,

    formatMoney(cents) {
      return `$${(cents / 100).toFixed(2)}`;
    },

    async updateQuantity(line, quantity) {
      if (quantity < 1) return;
      this.loading = true;

      try {
        const response = await fetch('/cart/change.js', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ line, quantity })
        });

        const cart = await response.json();
        this.items = cart.items;
        this.total_price = cart.total_price;
        
        // Update global cart store
        if (Alpine.store('cart')) {
          Alpine.store('cart').updateCart(cart);
        }
      } catch (error) {
        console.error('Error updating cart:', error);
      } finally {
        this.loading = false;
      }
    },

    async removeItem(line) {
      await this.updateQuantity(line, 0);
    },

    async updateNote() {
      try {
        await fetch('/cart/update.js', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ note: this.note })
        });
      } catch (error) {
        console.error('Error updating note:', error);
      }
    },

    checkout() {
      window.location.href = '/checkout';
    }
  }));
</script>

{% stylesheet %}
  .cart-page {
    padding: var(--space-2xl) 0;
    min-height: 60vh;
  }
  
  .cart-page__header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: var(--space-2xl);
    padding-bottom: var(--space-lg);
    border-bottom: 1px solid var(--color-border);
  }
  
  .cart-page__title {
    font-size: 2.5rem;
    font-weight: 400;
    margin: 0;
    letter-spacing: -0.02em;
  }
  
  .cart-page__continue {
    font-size: 0.875rem;
    color: var(--color-text-secondary);
    text-decoration: none;
    transition: var(--transition-base);
  }
  
  .cart-page__continue:hover {
    color: var(--color-text-primary);
  }
  
  .cart-empty {
    text-align: center;
    padding: var(--space-3xl) 0;
  }
  
  .cart-empty__content {
    max-width: 400px;
    margin: 0 auto;
  }
  
  .cart-empty__icon {
    width: 80px;
    height: 80px;
    margin: 0 auto var(--space-lg);
    color: var(--color-text-tertiary);
  }
  
  .cart-empty__title {
    font-size: 1.5rem;
    font-weight: 400;
    margin: 0 0 var(--space-sm);
  }
  
  .cart-empty__text {
    color: var(--color-text-secondary);
    margin-bottom: var(--space-xl);
  }
  
  .cart-content {
    display: grid;
    grid-template-columns: 1fr 380px;
    gap: var(--space-2xl);
    align-items: start;
  }
  
  @media (max-width: 1024px) {
    .cart-content {
      grid-template-columns: 1fr;
    }
  }
  
  .cart-items {
    display: flex;
    flex-direction: column;
    gap: var(--space-lg);
  }
  
  .cart-item {
    display: grid;
    grid-template-columns: 120px 1fr auto auto auto;
    gap: var(--space-lg);
    padding: var(--space-lg);
    background: var(--color-surface);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-md);
    align-items: center;
    transition: var(--transition-base);
  }
  
  .cart-item:hover {
    border-color: var(--color-border-dark);
  }
  
  @media (max-width: 768px) {
    .cart-item {
      grid-template-columns: 80px 1fr;
      gap: var(--space-md);
      padding: var(--space-md);
      position: relative;
    }
  }
  
  .cart-item__image {
    aspect-ratio: 3/4;
    overflow: hidden;
    border-radius: var(--radius-sm);
    background: var(--color-background-subtle);
  }
  
  .cart-item__image img {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }
  
  .cart-item__details {
    min-width: 0;
  }
  
  @media (max-width: 768px) {
    .cart-item__details {
      grid-column: 2;
    }
  }
  
  .cart-item__title {
    font-size: 1rem;
    font-weight: 500;
    margin: 0 0 var(--space-xs);
    line-height: 1.4;
  }
  
  .cart-item__title a {
    color: var(--color-text-primary);
    text-decoration: none;
    transition: var(--transition-base);
  }
  
  .cart-item__title a:hover {
    color: var(--color-accent);
  }
  
  .cart-item__variant {
    font-size: 0.875rem;
    color: var(--color-text-secondary);
    margin: 0 0 var(--space-xs);
  }
  
  .cart-item__price {
    font-size: 0.875rem;
    font-weight: 600;
    margin: 0;
  }
  
  @media (max-width: 768px) {
    .cart-item__price {
      margin-top: var(--space-sm);
    }
  }
  
  .cart-item__quantity {
    display: flex;
    align-items: center;
    gap: var(--space-xs);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-sm);
    padding: 2px;
    background: var(--color-surface);
  }
  
  @media (max-width: 768px) {
    .cart-item__quantity {
      grid-column: 2;
      justify-self: start;
      margin-top: var(--space-sm);
    }
  }
  
  .cart-item__quantity-btn {
    width: 32px;
    height: 32px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: none;
    border: none;
    cursor: pointer;
    transition: var(--transition-base);
    border-radius: var(--radius-xs);
  }
  
  .cart-item__quantity-btn:hover:not(:disabled) {
    background: var(--color-background-subtle);
  }
  
  .cart-item__quantity-btn:disabled {
    opacity: 0.3;
    cursor: not-allowed;
  }
  
  .cart-item__quantity-input {
    width: 50px;
    text-align: center;
    border: none;
    background: none;
    font-size: 0.875rem;
    font-weight: 500;
  }
  
  .cart-item__total {
    text-align: right;
    min-width: 80px;
  }
  
  @media (max-width: 768px) {
    .cart-item__total {
      position: absolute;
      top: var(--space-md);
      right: var(--space-md);
    }
  }
  
  .cart-item__total-price {
    font-size: 1rem;
    font-weight: 600;
    margin: 0;
  }
  
  .cart-item__remove {
    width: 36px;
    height: 36px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: none;
    border: 1px solid var(--color-border);
    border-radius: var(--radius-sm);
    cursor: pointer;
    transition: var(--transition-base);
  }
  
  .cart-item__remove:hover:not(:disabled) {
    border-color: var(--color-error);
    color: var(--color-error);
  }
  
  .cart-item__remove:disabled {
    opacity: 0.3;
    cursor: not-allowed;
  }
  
  @media (max-width: 768px) {
    .cart-item__remove {
      position: absolute;
      bottom: var(--space-md);
      right: var(--space-md);
    }
  }
  
  .cart-summary {
    position: sticky;
    top: calc(var(--header-height, 5rem) + var(--space-lg));
  }
  
  .cart-summary__content {
    padding: var(--space-xl);
    background: var(--color-background-subtle);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-md);
  }
  
  .cart-summary__title {
    font-size: 1.25rem;
    font-weight: 500;
    margin: 0 0 var(--space-lg);
  }
  
  .cart-summary__row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: var(--space-sm) 0;
    font-size: 1rem;
  }
  
  .cart-summary__row:last-of-type {
    border-top: 1px solid var(--color-border);
    padding-top: var(--space-md);
    font-weight: 600;
    font-size: 1.125rem;
    margin-bottom: var(--space-lg);
  }
  
  .cart-summary__note {
    margin: var(--space-lg) 0;
  }
  
  .cart-summary__note label {
    display: block;
    font-size: 0.875rem;
    font-weight: 500;
    margin-bottom: var(--space-xs);
  }
  
  .cart-summary__note-input {
    width: 100%;
    min-height: 80px;
    padding: var(--space-sm);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-sm);
    background: var(--color-surface);
    font-size: 0.875rem;
    resize: vertical;
    transition: var(--transition-base);
  }
  
  .cart-summary__note-input:focus {
    outline: none;
    border-color: var(--color-accent);
  }
  
  .cart-summary__shipping {
    font-size: 0.875rem;
    color: var(--color-text-secondary);
    text-align: center;
    margin: 0 0 var(--space-lg);
  }
  
  .cart-summary__checkout {
    width: 100%;
    justify-content: center;
  }
  
  .cart-loading {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(255, 255, 255, 0.8);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: var(--z-index-modal);
  }
  
  .cart-loading__spinner {
    width: 48px;
    height: 48px;
    border: 3px solid var(--color-border);
    border-top-color: var(--color-accent);
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
  }
  
  @keyframes spin {
    to { transform: rotate(360deg); }
  }
{% endstylesheet %}

{% schema %}
{
  "name": "t:general.cart",
  "settings": []
}
{% endschema %}
