{% comment %}
  Renders an image with proper responsive attributes and lazy loading

  Accepts:
  - image: {Object} Shopify image object
  - width: {Number} Max width of the image
  - height: {Number} Max height of the image
  - alt: {String} Alt text for the image
  - class: {String} CSS classes to add
  - loading: {String} Loading attribute (lazy/eager)
  - sizes: {String} Sizes attribute for responsive images
  - data-*: {String} Any data attributes

  Usage:
  {% render 'image', image: product.featured_image, width: 600, height: 800, alt: product.title %}
{% endcomment %}

{%- liquid
  assign image_alt = alt | default: image.alt | escape
  assign image_loading = loading | default: 'lazy'
  assign focal_point = image.presentation.focal_point | default: '50.0% 50.0%'
  
  # Calculate aspect ratio for placeholder
  if image.aspect_ratio
    assign image_aspect_ratio = image.aspect_ratio
  elsif width and height
    assign image_aspect_ratio = width | times: 1.0 | divided_by: height
  else
    assign image_aspect_ratio = 1.0
  endif
  
  # Generate srcset for responsive images
  assign widths = '165, 360, 535, 750, 1070, 1500'
  assign widths_array = widths | split: ', '
-%}

{%- if image != blank -%}
  <img
    src="{{ image | image_url: width: width }}"
    srcset="{%- for w in widths_array -%}
      {%- if image.width >= w -%}
        {{ image | image_url: width: w }} {{ w }}w{%- unless forloop.last -%},{%- endunless -%}
      {%- endif -%}
    {%- endfor -%}"
    width="{{ width }}"
    height="{{ height | default: width | divided_by: image_aspect_ratio | round }}"
    alt="{{ image_alt }}"
    loading="{{ image_loading }}"
    style="object-position: {{ focal_point }};"
    {% if class %}class="{{ class }}"{% endif %}
    {% if sizes %}sizes="{{ sizes }}"{% endif %}
    {% for attribute in attributes %}
      {{ attribute[0] }}="{{ attribute[1] }}"
    {% endfor %}
  >
{%- else -%}
  {%- comment -%} Placeholder when no image {%- endcomment -%}
  <div 
    class="placeholder-image {% if class %}{{ class }}{% endif %}"
    style="aspect-ratio: {{ image_aspect_ratio }};"
    {% for attribute in attributes %}
      {{ attribute[0] }}="{{ attribute[1] }}"
    {% endfor %}
  >
    {{ 'image' | placeholder_svg_tag }}
  </div>
{%- endif -%}